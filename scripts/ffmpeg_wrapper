#!/bin/sh

YB_MAX_XFORM_LOAD=${YB_MAX_XFORM_LOAD:-20}

# Don't let the load get out of control
# Just in case we spin up too many ffmpeg jobs, let them stall before
# starting if the system load is too high

LOAD="$(awk '{print $1}' /proc/loadavg | awk -F '.' '{print $1}')"
if [ -z "${LOAD}" ] ; then
  echo >&2 "${0}: $(date) Unable to determine load, running ffmpeg $*"
elif [ ${LOAD} -gt ${YB_MAX_LOAD} ] ; then
  while [ ${LOAD} -gt ${YB_MAX_LOAD} ] ; do
    echo >&2 "${0}: $(date) Load is too high (${LOAD}), waiting to start ffmpeg $*"
    sleep 10
    LOAD="$(awk '{print $1}' /proc/loadavg | awk -F '.' '{print $1}')"
    if [ -z "${LOAD}" ] ; then
      echo >&2 "${0}: $(date) Unable to determine load, running ffmpeg $*"
      break
    fi
  done
else
  echo >&2 "${0}: $(date) Load is OK (${LOAD}) we can run ffmpeg $*"
fi

ffmpeg "$@"
