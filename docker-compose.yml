version: '3'
services:
  nginx:
    restart: unless-stopped
    image: staticfloat/nginx-certbot
    ports:
      - "80:80/tcp"
      - "443:443/tcp"
    environment:
      CERTBOT_EMAIL: ${YB_CERTBOT_EMAIL}
      # variable names are space-separated
      ENVSUBST_VARS: FQDN APP_SERVER
      FQDN: ${YB_HOSTNAME}
      APP_SERVER: nuxt
    volumes:
      - ./conf.d:/etc/nginx/user.conf.d:ro
      - letsencrypt:/etc/letsencrypt

  redis:
    restart: unless-stopped
    image: redis
    ports:
      - "6379:6379/tcp"

  nuxt:
    restart: unless-stopped
    ports:
      - "3000:3000/tcp"
    build:
      context: .
      dockerfile: Dockerfile
      args:
        YB_ADMIN_EMAIL: ${YB_ADMIN_EMAIL:-admin@example.local}
        YB_ADMIN_PASSWORD: ${YB_ADMIN_PASSWORD:?Environment variable required but not defined:YB_ADMIN_PASSWORD}
        YB_DEST_KEY: ${YB_DEST_ACCESS:?Environment variable required but not defined:YB_DEST_ACCESS}
        YB_DEST_BUCKET: ${YB_DEST_BUCKET:?Environment variable required but not defined:YB_DEST_BUCKET}
        YB_DEST_PREFIX: ${YB_DEST_PREFIX}
        YB_DEST_REGION: ${YB_DEST_REGION:-us-east-1}
        YB_DEST_SECRET: ${YB_DEST_SECRET:?Environment variable required but not defined:YB_DEST_SECRET}
        YB_DATA_ENCRYPTION_KEY: ${YB_DATA_ENCRYPTION_KEY}
        YB_DATA_ENCRYPTION_IV: ${YB_DATA_ENCRYPTION_IV}
        YB_DATA_ENCRYPTION_ALGO: ${YB_DATA_ENCRYPTION_ALGO}
        YB_REDIS_HOST: redis
        YB_AUTOSCAN_INTERVAL: ${YB_AUTOSCAN_INTERVAL}
        YB_AUTOSCAN_INITIAL_DELAY: ${YB_AUTOSCAN_INITIAL_DELAY}
        YB_EMAIL_HOST: ${YB_EMAIL_HOST}
        YB_EMAIL_PORT: ${YB_EMAIL_PORT}
        YB_EMAIL_USER: ${YB_EMAIL_USER}
        YB_EMAIL_PASSWORD: ${YB_EMAIL_PASSWORD}
        YB_EMAIL_SECURE: ${YB_EMAIL_SECURE}
        YB_EMAIL_FROM: ${YB_EMAIL_FROM}

volumes:
  letsencrypt:
