<!-- DO NOT EDIT THIS FILE. AUTO-GENERATED BY mobiletto-orm-typedef-gen -->

<template>
  <v-container>
    <v-row v-if="successSnackbar && successSnackbar.length > 0">
      <KitSnackbarSuccess :text="successSnackbar" />
    </v-row>
    <v-row v-else-if="errorSnackbar && errorSnackbar.length > 0">
      <KitSnackbarError :text="errorSnackbar" />
    </v-row>
    <v-row>
      <v-col>
        <h2>{{ adminTitle() }}</h2>
        <b v-if="messageExists('admin_title_localConfig_administration_details', messages)">
          {{ messages.admin_title_localConfig_administration_details }}
        </b>
      </v-col>
    </v-row>
    <v-row v-if="addingObject">
      <v-col>
        <OrmForm
          v-if="allRefsLoaded() && localConfigTypeDef"
          form-name="add_localConfig_form"
          :type-def="localConfigTypeDef"
          :type-name-message="typeNameMessage"
          :thing="addObject"
          :fields="localConfigTypeDefFields"
          :create="true"
          :read-only-object="() => false"
          :server-errors="createLocalConfigServerErrors"
          :label-prefixes="labelPfx"
          :hint-suffixes="['_description']"
          @submitted="onAddSubmitted"
          @update="onAddUpdated"
          @cancel="onAddCancel"
        />
      </v-col>
    </v-row>
    <v-row v-else-if="Object.keys(editingObject).length > 0">
      <v-col>
        <OrmForm
          v-if="allRefsLoaded() && localConfigTypeDef"
          form-name="edit_localConfig_form"
          :type-def="localConfigTypeDef"
          type-name-message="typeNameMessage"
          :thing="editingObject"
          :fields="localConfigTypeDefFields"
          :create="false"
          :read-only-object="() => false"
          :server-errors="editLocalConfigServerErrors"
          :label-prefixes="labelPfx"
          :hint-suffixes="['_description']"
          @submitted="onEditSubmitted"
          @update="onEditUpdated"
          @cancel="onEditCancel"
        />
      </v-col>
    </v-row>
    <v-row v-else>
      <v-col>
        <Icon name="LoadingIcon" />
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup lang="ts">
  import { ref, watch, Ref } from "vue";
  import { storeToRefs } from "pinia";
  import {
    MobilettoOrmFieldDefConfig,
    MobilettoOrmObject,
    MobilettoOrmTypeDef,
    MobilettoOrmValidationErrors,
    metaField
  } from "mobiletto-orm-typedef";
  import { LocalConfigType, LocalConfigTypeDef } from "yuebing-model";
  import { findMessage, messageExists, parseMessage } from "hokey-runtime";
  import { useSessionStore } from "~/stores/sessionStore";
  import { useLocalConfigStore } from "~/stores/model/localConfigStore";
  import { ActionConfig, deepUpdate } from "~/utils/model/adminHelper";
  import { MobilettoOrmFindApiOpts } from "~/utils/model/storeHelper";
  const successSnackbar = ref("");
  const errorSnackbar = ref("");
  const props = withDefaults(
    defineProps<{
      labelPrefixes: string[];
      typeNameMessage: string;
      msgAddSuccess: string;
      msgAddError: string;
      msgEditSuccess: string;
      msgEditError: string;
      msgFindSingletonError: string;
    }>(),{
      labelPrefixes: () => ["label_", ""],
      typeNameMessage: () => "typename_localConfig",
      msgAddSuccess: () => "admin_info_added",
      msgAddError: () => "admin_info_add_error",
      msgEditSuccess: () => "admin_info_edited",
      msgEditError: () => "admin_info_edit_error",
      msgFindSingletonError: () => "admin_info_findSingleton_error",
    },
  );

  const emit = defineEmits<{
    added: [obj: MobilettoOrmObject];
    addCanceled: [];
    edited: [obj: MobilettoOrmObject];
    editCanceled: [obj: MobilettoOrmObject];
  }>();

  const labelPfx: Ref<string[]> = ref(["admin_label_localConfig_", "label_", ""]);
  if (props.labelPrefixes) {
    props.labelPrefixes.forEach((p: string) => {
      if (!labelPfx.value.includes(p)) labelPfx.value.unshift(p);
    });
  }

  const sessionStore = useSessionStore();
  const { localeMessages } = storeToRefs(sessionStore);
  const messages = localeMessages;

  const adminTitle = () => messageExists("admin_title_localConfig_administration", messages.value)
    ? messages.value.admin_title_localConfig_administration
    : parseMessage("admin_title_site_administration", messages.value, { title: findMessage(props.typeNameMessage, messages.value, [""])});

  const addingObject = ref(false);
  const addObject = ref({} as LocalConfigType);
  const createLocalConfigServerErrors = ref({} as MobilettoOrmValidationErrors);

  const editingObject = ref({} as LocalConfigType);
  const editLocalConfigServerErrors = ref({} as MobilettoOrmValidationErrors);

  const localConfigStore = useLocalConfigStore();
  const { found } = storeToRefs(localConfigStore);
  
  const localConfigTypeDef: Ref<MobilettoOrmTypeDef | null> = ref(null);
  const localConfigTypeDefFields: Ref<MobilettoOrmFieldDefConfig[] | undefined> = ref(undefined);
  const findSingletonLocalConfigServerErrors = ref({} as MobilettoOrmValidationErrors);
  

  const allRefsLoaded = () => true;
  localConfigTypeDef.value = LocalConfigTypeDef;
  localConfigTypeDefFields.value = LocalConfigTypeDef.tabIndexedFields();

  const onAddUpdated = (update: { field: string; value: any }) => {
    deepUpdate(addObject.value, update.field, update.value);
  };
  const onAddSubmitted = async (obj: MobilettoOrmObject) => {
    await localConfigStore
      .create(obj as LocalConfigType, createLocalConfigServerErrors);
    addingObject.value = false;
    successSnackbar.value = parseMessage(props.msgAddSuccess, messages.value, {
        type: messages.value.typename_localConfig,
        id: LocalConfigTypeDef.id(obj),
    });
    emit("added", obj);
    return await localConfigStore.lookup(findSingletonLocalConfigServerErrors);
  }
  watch(createLocalConfigServerErrors, () => {
    if (createLocalConfigServerErrors.value && Object.keys(createLocalConfigServerErrors.value).length > 0) {
      errorSnackbar.value = parseMessage(props.msgAddError, messages.value, {
        type: messages.value.typename_localConfig,
        error: JSON.stringify(createLocalConfigServerErrors),
      });
    }
  });

  const showAddOrm = () => {
    addingObject.value = true;
  };
  const onAddCancel = () => {
    addingObject.value = false;
    emit("addCanceled");
  };

  const onEditUpdated = (update: { field: string; value: any }) => {
    if (editingObject.value) {
      deepUpdate(editingObject.value, update.field, update.value);
    }
  };

  const onEditSubmitted = async (obj: MobilettoOrmObject) => {
    await localConfigStore
      .update(obj as LocalConfigType, editLocalConfigServerErrors);
    
    successSnackbar.value = parseMessage(props.msgEditSuccess, messages.value, {
      type: messages.value.typename_localConfig,
      id: LocalConfigTypeDef.id(obj),
    });
    emit("edited", obj);
    return await localConfigStore.lookup(findSingletonLocalConfigServerErrors);
  };
  watch(editLocalConfigServerErrors, () => {
    if (editLocalConfigServerErrors.value && Object.keys(editLocalConfigServerErrors.value).length > 0) {
      errorSnackbar.value = parseMessage(props.msgEditError, messages.value, {
        type: messages.value.typename_localConfig,
        id: LocalConfigTypeDef.id(editingObject.value),
        error: JSON.stringify(editLocalConfigServerErrors),
      });
    }
  });

  const showEditOrm = (obj: MobilettoOrmObject) => {
    if (Object.keys(editingObject.value).length > 0) {
      // already editing something else
      return;
    }
    if (obj) {
      const id = LocalConfigTypeDef.id(obj);
      if (id && id.length > 0) {
        addingObject.value = false; // ensure add form is closed
        editingObject.value = JSON.parse(JSON.stringify(obj)) as LocalConfigType;
      }
    }
  };
  const onEditCancel = () => {
    emit("editCanceled", editingObject.value);
    editingObject.value = JSON.parse(JSON.stringify(found.value)) as LocalConfigType;
  };
  watch(found, () => {
    if (found.value && LocalConfigTypeDef.id(found.value)) {
      showEditOrm(JSON.parse(JSON.stringify(found.value)));
    } else {
      showAddOrm();
    }
  });
  watch(findSingletonLocalConfigServerErrors, () => {
    if (findSingletonLocalConfigServerErrors.value && Object.keys(findSingletonLocalConfigServerErrors.value).length > 0) {
      errorSnackbar.value = parseMessage(props.msgFindSingletonError, messages.value, {
        type: messages.value.typename_localConfig,
        error: JSON.stringify(findSingletonLocalConfigServerErrors),
      });
    }
  });

  const initRefs = async () => {
    return await localConfigStore.lookup(findSingletonLocalConfigServerErrors);
  };
  initRefs()
      .then(obj => showEditOrm(obj))
      .catch(_e => showAddOrm());
</script>
