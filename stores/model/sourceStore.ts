// DO NOT EDIT THIS FILE. AUTO-GENERATED BY mobiletto-orm-typedef-gen

import { Ref } from "vue";
import { defineStore } from "pinia";
import { MobilettoOrmValidationErrors } from "mobiletto-orm";
import { SourceType, SourceTypeDef } from "yuebing-model";
import { sourceService } from "~/utils/services/model/sourceService";

const updateList = (list: SourceType[] | null, id: string, opts?: { source?: SourceType; remove?: boolean }) => {
  if (!opts) return;
  if (list) {
    const foundIndex = list.findIndex((e) => SourceTypeDef.id(e) === id);
    if (foundIndex && foundIndex >= 0) {
      if (opts && opts.remove === true) {
        list.splice(foundIndex, 1);
      } else if (opts && opts.source) {
        list.splice(foundIndex, 1, opts.source);
      }
    }
  }
};

export const useSourceStore = defineStore("source", {
  state: () => ({
    source: null as SourceType | null,
    sourceList: null as SourceType[] | null,
  }),
  actions: {
    async sourceLookup(id: string, serverErrors: Ref<MobilettoOrmValidationErrors>): Promise<SourceType> {
      this.source = await sourceService.findSource(id, serverErrors);
      updateList(this.sourceList, SourceTypeDef.id(this.source), { source: this.source });
      return this.source;
    },
    async sourceSearch(query?: MobilettoOrmFindApiOpts): Promise<SourceType[]> {
      this.sourceList = await sourceService.searchSource(query);
      return this.sourceList || [];
    },
    async sourceCreate(source: SourceType, serverErrors: Ref<MobilettoOrmValidationErrors>): Promise<SourceType> {
      this.source = await sourceService.createSource(source, serverErrors);
      return this.source;
    },
    async sourceUpdate(source: SourceType, serverErrors: Ref<MobilettoOrmValidationErrors>): Promise<SourceType> {
      this.source = await sourceService.updateSource(source, serverErrors);
      updateList(this.sourceList, SourceTypeDef.id(this.source), { source: this.source });
      return this.source;
    },
    async sourceDelete(
      source: string,
      serverErrors: Ref<MobilettoOrmValidationErrors>,
      purge?: boolean,
    ): Promise<boolean> {
      const deleteResult = await sourceService.deleteSource(source, serverErrors, !!purge);
      if (deleteResult) {
        updateList(this.sourceList, source, serverErrors, { remove: true });
        return true;
      }
      return false;
    },
  },
});
